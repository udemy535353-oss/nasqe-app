

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesajlar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body { background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; }
        .chat-app { height: 100vh; display: flex; padding: 0; }
        .conversations-sidebar { background-color: #ffffff; border-right: 1px solid #ddd; display: flex; flex-direction: column; height: 100vh; }
        .sidebar-header { padding: 1.25rem 1rem; border-bottom: 1px solid #ddd; }
        .sidebar-header h4 { font-weight: 600; }
        .search-bar { padding: 0.75rem 1rem; background-color: #f0f2f5; }
        .search-bar input { border: none; border-radius: 50px; }
        .conversation-list { flex-grow: 1; overflow-y: auto; }
        .conversation-item { display: flex; align-items: center; padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.2s ease; border-bottom: 1px solid #f0f2f5; }
        .conversation-item:hover { background-color: #f5f5f5; }
        .conversation-item.active { background-color: #e6f2ff; }
        .profile-pic { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 1rem; }
        .conversation-details { flex-grow: 1; overflow: hidden; }
        .conversation-details .name { font-weight: 600; color: #1c1e21; }
        .conversation-details .last-message { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #65676b; font-size: 0.9rem; }
        .timestamp { font-size: 0.75rem; color: #65676b; margin-left: 1rem; }
        .chat-window-container { display: flex; flex-direction: column; height: 100vh; padding: 0; }
        .chat-window { display: none; flex-direction: column; height: 100%; width: 100%; }
        .chat-window.active { display: flex; }
        .chat-header { background-color: #ffffff; padding: 0.75rem 1.5rem; border-bottom: 1px solid #ddd; display: flex; align-items: center; flex-shrink: 0; }
        .chat-header .name { font-weight: 600; }
        .messages-area { flex-grow: 1; padding: 1.5rem; overflow-y: auto; display: flex; flex-direction: column; }
        .message { display: flex; margin-bottom: 1rem; max-width: 70%; }
        .message-bubble { padding: 0.75rem 1rem; border-radius: 18px; font-size: 0.95rem; line-height: 1.4; }
        .message.received { align-self: flex-start; }
        .message.received .message-bubble { background-color: #e4e6eb; color: #050505; }
        .message.sent { align-self: flex-end; }
        .message.sent .message-bubble { background-color: #0084ff; color: white; }
        .message-input { background-color: #ffffff; padding: 1rem 1.5rem; border-top: 1px solid #ddd; display: flex; align-items: center; flex-shrink: 0; }
        .message-input input { flex-grow: 1; border: none; background-color: #f0f2f5; border-radius: 50px; padding: 0.75rem 1.25rem; }
        .message-input input:focus { outline: none; }
        .message-input button { background: none; border: none; color: #0084ff; font-size: 1.5rem; margin-left: 1rem; cursor: pointer; }
        .time {
            text-align:right;
            font-size: 0.85rem;
            color:#c4c5c7;
        }
        .timey {
            text-align:left;
            font-size: 0.85rem;
            color:#c4c5c7;
        }
    </style>
</head>
<body>
    <div class="container-fluid chat-app">
        
        <div class="col-12 col-md-4 col-lg-3 conversations-sidebar">
            <div class="sidebar-header"><h4>Sohbetler</h4></div>
            <div class="search-bar"><input type="text" class="form-control" placeholder="Sohbetlerde ara..."></div>
            
            <div class="conversation-list">
                
                
                
                
            
                {% for b in follow %}
                <a href="/inbox/t/{{b.follow_id}}" type="button">
                <div class="conversation-item" data-chat="elif">
                    <img src="https://placehold.co/100x100/82A6E8/FFFFFF" alt="Profil" class="profile-pic">
                    <div class="conversation-details"><div class="name">{{b.follow}} </div><div class="last-message">Proje dosyasını sana gönderdim.</div></div>
                    
                </div>
                </a>
                {% endfor %}
            
            
                
            </div>
        </div>
        <div class="col-12 col-md-8 col-lg-9 chat-window-container">
            <div class="chat-window active" id="chat-ahmet">
                
                <div class="chat-header"><img src="https://placehold.co/100x100/E89F82/FFFFFF" alt="Profil" class="profile-pic"><div><div class="name">{{num}}</div><small class="text-muted">Aktif</small></div></div>
                
                
                <div class="messages-area">
                    {% for c in chat %} 
    {% if c.sender == num %}
    <p class="timey">{{c.time}}</p>
    <div class="message received">
        <div class="message-bubble">{{ c.message }}</div>
    </div>
{% else %}
    <p class="time">{{c.time}}</p>
    <div class="message sent">
        <div class="message-bubble">{{ c.message }}</div>
    </div>
{% endif %}
{% endfor %}
                </div>
                <div class="message-input"><input type="text" placeholder="Bir mesaj yaz..."><button type="submit"><i class="fas fa-paper-plane"></i></button></div>
            </div>
            <div class="chat-window" id="chat-elif">
                <div class="chat-header"><img src="https://placehold.co/100x100/82A6E8/FFFFFF" alt="Profil" class="profile-pic"><div class="name">Elif Kaya</div></div>
                <div class="messages-area">
                    <div class="message sent"><div class="message-bubble">Elif selam, proje dosyalarını bekliyorum.</div></div>
                    <div class="message received"><div class="message-bubble">Proje dosyasını sana gönderdim.</div></div>
                </div>
                <div class="message-input"><input type="text" placeholder="Bir mesaj yaz..."><button type="submit"><i class="fas fa-paper-plane"></i></button></div>
            </div>
            <div class="chat-window" id="chat-zeynep">
                <div class="chat-header"><img src="https://placehold.co/100x100/A1E882/FFFFFF" alt="Profil" class="profile-pic"><div class="name">Zeynep Demir</div></div>
                <div class="messages-area"><div class="message received"><div class="message-bubble">Fotoğraflar için teşekkürler :)</div></div></div>
                <div class="message-input"><input type="text" placeholder="Bir mesaj yaz..."><button type="submit"><i class="fas fa-paper-plane"></i></button></div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
document.addEventListener('DOMContentLoaded', function() {
    



    

    
    function sendMessage(inputElement) {
        const messageText = inputElement.value.trim();
        if (messageText === '') { return; }

        const activeChatWindow = document.querySelector('.chat-window.active');
        if (!activeChatWindow) {
            console.error("Aktif sohbet penceresi bulunamadı!");
            return; 
        }
        
        const messagesArea = activeChatWindow.querySelector('.messages-area');
        const receiverName = activeChatWindow.querySelector('.chat-header .name').textContent;

        // 1. Mesajı ekranda hemen göster
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message sent';
        messageDiv.innerHTML = `<div class="message-bubble">${messageText}</div>`;
        messagesArea.appendChild(messageDiv);

        inputElement.value = '';
        messagesArea.scrollTop = messagesArea.scrollHeight;
        inputElement.focus();

        // 2. Mesajı veritabanına gönder
        fetch('/api/send_message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                text: messageText,               
                receiver_name: receiverName,     
                sender_name: "{{ name }}", 
                conversation_id: activeChatWindow.dataset.conversation, 
                timestamp: new Date().toISOString() 
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                console.log('Mesaj veritabanına kaydedildi.');
            } else {
                console.error('Mesaj kaydedilemedi:', data.message);
            }
        })
        .catch(error => {
            console.error('Sunucuya bağlanırken hata oluştu:', error);
        });
    }

    // Buton ve Enter tuşu
    document.body.addEventListener('click', function(event) {
        const sendButton = event.target.closest('.message-input button');
        if (sendButton) {
            const inputElement = sendButton.previousElementSibling;
            sendMessage(inputElement);
        }
    });

    document.body.addEventListener('keydown', function(event) {
        if (event.target.matches('.message-input input') && event.key === 'Enter') {
            event.preventDefault();
            sendMessage(event.target);
        }
    });
});
const searchInput = document.querySelector('.search-bar input');
    const conversationItems = document.querySelectorAll('.conversation-item');

    searchInput.addEventListener('keyup', function() {
        const query = searchInput.value.toLowerCase().trim();

        conversationItems.forEach(item => {
            const name = item.querySelector('.conversation-details .name').textContent.toLowerCase();
            const lastMessage = item.querySelector('.conversation-details .last-message').textContent.toLowerCase();

            if (name.includes(query) || lastMessage.includes(query)) {
                item.parentElement.style.display = 'block';  // <a> etiketi görünür
            } else {
                item.parentElement.style.display = 'none';   // <a> etiketi gizlenir
            }
        });
    });
;
</script>


</body>
</html>

