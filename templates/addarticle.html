
{% extends "layout.html" %}
{% block title %}
Blog Oluştur
{% endblock %}
{% block gui %}

<style>
    /* form-control sınıfına sahip tüm input ve textarea öğelerinin kenarlıklarını kalınlaştır */
    .form-control {
        border: 3px solid #ced4da; /* Varsayılan kenarlık rengi, 2px kalınlık */
        padding: 0.375rem 0.75rem; /* Kenarlık kalınlaştığında iç boşluğu koru */
        border-radius: 0.25rem; /* Köşe yuvarlaklığını koru */
        box-sizing: border-box;
        font: Helvetica;
        margin: 10px; /* Mevcut margin stilini koru */
    }
    .form-control:focus {
        border-color: #000000;
    }
    
    /*
    REGISTER VE LOGİN SAYFALARINDAN KOPYALANAN STİLLER.
    Animasyonlu uyarı mesajı için gereklidir.
    */
    .form-group {
        position: relative;
        margin-bottom: 25px;
    }
    .form-control.is-invalid {
        border-color: #dc3545;
        padding-right: calc(1.5em + 0.75rem);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }
    .validation-message {
        position: absolute;
        top: 100%;
        left: 0;
        margin-top: 5px;
        background-color: #ffc107;
        color: #343a40;
        padding: 8px 12px;
        border-radius: 5px;
        font-size: 0.875rem;
        white-space: nowrap;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transform: translateY(-10px);
        transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        z-index: 10;
        display: flex;
        align-items: center;
    }
    .validation-message::before {
        content: '';
        position: absolute;
        bottom: 100%;
        left: 15px;
        border-width: 8px;
        border-style: solid;
        border-color: transparent transparent #ffc107 transparent;
    }
    .validation-message.show {
        opacity: 1;
        transform: translateY(0);
    }
    .validation-message .icon {
        margin-right: 8px;
        font-weight: bold;
        font-size: 1.1em;
        color: #dc3545;
    }

    /* Buton stili (mevcut stiliniz) */
    .btn.btn-primary {
        color: #000000;
        font-weight: bold;
        background-color:darkorange;
        border: 2px solid #fff;
        border-radius: 18px;
        transform: translateX(100deg)
    }
    .btn.btn-primary:hover {
        background-color:#cc6c00;
        border-color: #000000;
    }
</style>

<h2>Blog oluştur</h2>
<hr>

{% from "includes/formhelpers.html" import render_field %}
<form method="post" novalidate id="addArticleForm">
  <dl>
    <div class="mb-3 form-group">
        {{ render_field(form.title, class="form-control", placeholder="Başlık", id="title", data_error_message="Lütfen bir başlık girin.") }}
        <div class="validation-message" id="title-error">
            <span class="icon">!</span> Lütfen bir başlık girin.
        </div>
    </div>
    
    <div class="mb-3 form-group">
        {{ render_field(form.content, class="form-control", placeholder="İçerik", id="content", data_error_message="Lütfen makale içeriğini girin.") }}
        <div class="validation-message" id="content-error">
            <span class="icon">!</span> Lütfen makale içeriğini girin.
        </div>
    </div>
  </dl>
  <button type="submit" class="btn btn-primary">blog ekle</button>
</form>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('addArticleForm');
        // 'content' textarea'sını CKEditor tarafından ele alındığı için ayrı seçiyoruz.
        const titleInput = document.getElementById('title');
        const contentTextarea = document.getElementById('content'); // Orijinal textarea

        // CKEditor'ün yüklendiğinden emin olmak için kontrol
        if (typeof CKEDITOR !== 'undefined' && CKEDITOR.instances.content) {
            const editor = CKEDITOR.instances.content;

            // CKEditor içeriğini almak için yardımcı fonksiyon
            function getEditorContent() {
                // CKEditor'dan içeriği al ve boşlukları temizle
                return editor.getData().trim();
            }

            // CKEditor için hata mesajını göster
            function showCkeditorValidationError(errorMessage) {
                const errorDiv = document.getElementById('content-error');
                if (errorDiv) {
                    errorDiv.querySelector('.icon').nextSibling.textContent = ' ' + errorMessage;
                    errorDiv.classList.add('show');
                    // CKEditor'ın kendi görselini işaretlemek daha karmaşık olabilir,
                    // şimdilik sadece mesajı gösteriyoruz.
                    // editor.container.$.style.borderColor = '#dc3545'; // CKEditor çerçevesini renklendirmek için
                }
            }

            // CKEditor için hata mesajını gizle
            function hideCkeditorValidationError() {
                const errorDiv = document.getElementById('content-error');
                if (errorDiv) {
                    errorDiv.classList.remove('show');
                    // editor.container.$.style.borderColor = '#ced4da'; // Çerçeveyi normale döndürmek için
                }
            }

            // CKEditor içeriğini doğrula
            function validateCkeditorContent() {
                const content = getEditorContent();
                let isValid = true;
                let errorMessage = contentTextarea.dataset.errorMessage || 'Bu alan zorunludur.';

                if (content === '') {
                    isValid = false;
                }

                if (!isValid) {
                    showCkeditorValidationError(errorMessage);
                } else {
                    hideCkeditorValidationError();
                }
                return isValid;
            }

            // CKEditor'ın 'change' ve 'blur' olaylarını dinle
            editor.on('change', validateCkeditorContent);
            editor.on('blur', validateCkeditorContent);

            // Diğer inputlar için genel validasyon fonksiyonları
            function showValidationError(inputElement, errorMessage) {
                const errorDiv = document.getElementById(inputElement.id + '-error');
                if (errorDiv) {
                    errorDiv.querySelector('.icon').nextSibling.textContent = ' ' + errorMessage;
                    errorDiv.classList.add('show');
                    inputElement.classList.add('is-invalid');
                    inputElement.setAttribute('aria-invalid', 'true');
                }
            }

            function hideValidationError(inputElement) {
                const errorDiv = document.getElementById(inputElement.id + '-error');
                if (errorDiv) {
                    errorDiv.classList.remove('show');
                    inputElement.classList.remove('is-invalid');
                    inputElement.removeAttribute('aria-invalid');
                }
            }

            function validateInput(input) {
                let isValid = true;
                let errorMessage = input.dataset.errorMessage || 'Bu alan zorunludur.';

                if (input.value.trim() === '') {
                    isValid = false;
                }

                if (!isValid) {
                    showValidationError(input, errorMessage);
                } else {
                    hideValidationError(input);
                }
                return isValid;
            }

            // Başlık inputu için olay dinleyicileri
            titleInput.addEventListener('input', () => validateInput(titleInput));
            titleInput.addEventListener('blur', () => validateInput(titleInput));

            // Form gönderildiğinde tüm alanları kontrol et
            form.addEventListener('submit', (event) => {
                let formIsValid = true;

                // Başlık alanını doğrula
                if (!validateInput(titleInput)) {
                    formIsValid = false;
                }

                // CKEditor içeriğini doğrula
                if (!validateCkeditorContent()) {
                    formIsValid = false;
                }

                if (!formIsValid) {
                    event.preventDefault(); // Formu göndermeyi engelle

                    // İlk geçersiz alana odaklan
                    const firstInvalidInput = form.querySelector('.form-control.is-invalid');
                    if (firstInvalidInput) {
                        firstInvalidInput.focus();
                    } else if (!validateCkeditorContent()) { // Eğer sadece CKEditor geçersizse
                        editor.focus(); // CKEditor'e odaklan
                    }
                }
            });
        } else {
            // CKEditor yüklenmezse veya bulunamazsa standart textarea validasyonu
            console.warn("CKEditor instance 'content' not found. Standard textarea validation will apply.");
            const inputs = form.querySelectorAll('input:not([type="submit"]):not([type="hidden"]), textarea');
            inputs.forEach(input => {
                input.addEventListener('input', () => validateInput(input));
                input.addEventListener('blur', () => validateInput(input));
            });
            form.addEventListener('submit', (event) => {
                let formIsValid = true;
                inputs.forEach(input => {
                    if (!validateInput(input)) {
                        formIsValid = false;
                    }
                });
                if (!formIsValid) {
                    event.preventDefault();
                    const firstInvalidInput = form.querySelector('.form-control.is-invalid');
                    if (firstInvalidInput) {
                        firstInvalidInput.focus();
                    }
                }
            });
        }
    });
</script>


{% endblock %}
```