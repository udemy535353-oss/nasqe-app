{% extends "layout.html"%}

{% block title %}
    Register
{% endblock %}

{% block gui%}
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        // --- 1. KENDİ FIREBASE AYARLARINIZI BURAYA EKLEYİN ---
        const firebaseConfig = {
            apiKey: "AIzaSyChR0fgAC4xrgDf9FRpqjfWn6l4gQ_HQSU",
            authDomain: "nasqeprevoisly.firebaseapp.com",
            projectId: "nasqeprevoisly",
            storageBucket: "nasqeprevoisly.firebasestorage.app",
            messagingSenderId: "820508877235",
            appId: "1:820508877235:web:909023e58f364e7bfbebc6",
            measurementId: "G-NZ5VM53HM1"
            // Diğer ayarlar...
        };

        // Firebase'i Başlat
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); 

        // Elementleri yakalama
        const emailInput = document.getElementById('email'); 
        const passwordInput = document.getElementById('password');
        const messageElement = document.getElementById('message');

        // Mesaj gösterme yardımcısı
        function showMessage(msg, isError = false) {
            messageElement.textContent = msg;
            messageElement.style.color = isError ? 'red' : 'green';
        }

        // Doğrulama Bağlantısını Gönderme Fonksiyonu
        function sendVerificationEmail(user, redirectUrl) {
            // Doğrulama bağlantısının tıklanmasından sonra kullanıcıyı yönlendireceği URL'yi ayarlayın
            const actionCodeSettings = {
                url: redirectUrl, 
                handleCodeInApp: false, // Mobil uygulama değil, web olduğu için false
            };

            user.sendEmailVerification(actionCodeSettings)
                .then(() => {
                    showMessage(`Doğrulama e-postası başarıyla gönderildi: ${user.email}. Yönlendiriliyorsunuz...`);
                    
                    // Başarılı gönderimin ardından belirtilen sayfaya yönlendir
                    window.location.href = "verify.html"; 
                })
                .catch((error) => {
                    showMessage(`Hata: Doğrulama e-postası gönderilirken sorun oluştu: ${error.message}`, true);
                    console.error("E-posta Gönderme Hatası:", error);
                });
        }

        // -----------------------------------------------------
        // KAYIT OLMA İŞLEMİ (SIGN UP)
        // -----------------------------------------------------
        function signUp() {
            const email = emailInput.value;
            const password = passwordInput.value;
            
            if (!email || !password || password.length < 6) {
                showMessage("Lütfen geçerli bir e-posta ve en az 6 karakterli bir şifre girin.", true);
                return;
            }

            showMessage("Kayıt olunuyor ve doğrulama hazırlanıyor...", false);

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    
                    // 1. ADIM: Kullanıcı BAŞARILIYLA oluşturuldu
                    
                    // 2. ADIM: Doğrulama bağlantısını gönder ve YÖNLENDİRME yap
                    
                    // *** Yönlendirilmesini istediğiniz URL'yi buraya yazın ***
                    const verificationRedirectUrl = "http://localhost:8080/dashboard.html"; // Örnek URL: Doğrulama sonrası ana sayfa
                    
                    sendVerificationEmail(user, verificationRedirectUrl);
                    
                })
                .catch((error) => {
                    // Hata Yönetimi
                    let errorMessage = error.message;
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = "Bu e-posta adresi zaten kayıtlı. Lütfen giriş yapın.";
                    }
                    showMessage(`Kayıt Hatası: ${errorMessage}`, true);
                    console.error("Kayıt Hatası:", error);
                });
        }
    </script>
<script src="{{ url_for('static', filename='main.js') }}" defer type="module"></script>
<style>
    /* CUSTOM VALIDATION MESSAGE STYLES - Resimdeki gibi animasyonlu uyarı için */
    .form-group {
        position: relative; /* Bu, içindeki validation-message'ın konumunu belirlemek için */
        margin-bottom: 25px; /* Uyarı baloncuğuna yer açmak için artırılmış boşluk */
    }

    /* Input'a geçersiz sınıfı eklendiğinde kenarlık rengi */
    .form-control.is-invalid { /* Bootstrap'ın 'is-invalid' sınıfını kullanacağız */
        border-color: #dc3545; /* Bootstrap'ın hata rengi */
        padding-right: calc(1.5em + 0.75rem); /* İkon için boşluk */
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e"); /* Bootstrap'ın hata ikonu */
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }
    body {
        background-image: url("{{ url_for('static', filename='tro.jpg') }}");
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center;
        background-attachment: fixed;
        color:white;
        font-family: Google Sans, sans-serif !important;
    }
    span.icon {
        color: white; /* Bootstrap'ın hata rengi */
        margin-right: 8px; /* İkon ile metin arasında boşluk */
    }


    /* Özel uyarı balonu stili */
    .validation-message {
        position: absolute;
        top: 100%; /* Input'un hemen altında */
        left: 0;
        margin-top: 5px; /* Input ile uyarı arasında boşluk */
        background-color: #ffc107; /* Bootstrap'ın warning rengi (turuncuya yakın) */
        color: #343a40; /* Koyu yazı rengi */
        padding: 8px 12px;
        border-radius: 5px;
        font-size: 0.875rem; /* Daha küçük font */
        white-space: nowrap; /* Mesajın tek satırda kalmasını sağlar */
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        opacity: 0; /* Başlangıçta gizli */
        transform: translateY(-10px); /* Hafif yukarıda başlat */
        transition: opacity 0.3s ease-out, transform 0.3s ease-out; /* Animasyon */
        z-index: 10; /* Diğer elementlerin üzerinde görünmesini sağlar */
        display: flex; /* İçindeki ikon ve metni hizalamak için */
        align-items: center;
    }

    .validation-message::before { /* Baloncuğun üçgen kısmı */
        content: '';
        position: absolute;
        bottom: 100%;
        left: 15px; /* Okun konumu */
        border-width: 8px;
        border-style: solid;
        border-color: transparent transparent #ffc107 transparent;
    }

    .validation-message.show { /* JavaScript ile gösterildiğinde */
        opacity: 1;
        transform: translateY(0);
    }

    .validation-message .icon {
        margin-right: 8px;
        /* Bootstrap Icons veya Font Awesome kullanmıyorsanız, manuel bir ünlem işareti */
        font-weight: bold;
        font-size: 1.1em;
        color: #dc3545; /* Ünlem işareti için kırmızı renk */
    }
    .card {
        background: transparent;
        backdrop-filter: blur(5px);
        border:2px solid white;
        border-radius: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin-top:50px;

    }

    .card,
    .card-header,
    .card-footer,
    .card-header h3,
    .card-footer small,
    .card-footer small a {
        color: white !important;
    }
    .mb-3 {

    }
    .form-control {
        background: transparent;
        border-radius: 44px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        height: 50px; /* Input yüksekliği */
        padding: 0 20px;

    }
    .form-control:hover {
        border: 2px solid lightblue;
        transition: all 0.5s ease;

    }
    /* Düzeltilmiş ve Genişletilmiş Buton Stili */
    button.btn-primary,.google-button {
        padding: 10px 25px !important;
        min-height: 50px !important;
        margin-top:15px;
        background-color: #fff !important;
        border-color: #0d6efd !important;
        font-size: 1.1rem !important;
        font-weight: bold !important;
        color: black !important;
        position: relative;
        z-index: 1;
        transition: transform 0.5s ease-in-out;
        width: 100%; /* Butonun kapsayıcısını tamamen doldurmasını sağlar */
    }
    button.btn-primary:hover,.google-button:hover {
        z-index: 10;
        transform: scale(1.03);
        background-color: #a8a4a4; /* Bootstrap'ın primary rengi */
        border-color: #007bff;
    }
    .form-control::placeholder {
        color: rgba(255, 255, 255, 0.5); /* Placeholder için daha açık beyaz */
    }
    .form-group {
        position: relative; /* Bu, içindeki validation-message'ın konumunu belirlemek için */
        margin-bottom: 25px; /* Uyarı baloncuğuna yer açmak için artırılmış boşluk */
    }
    .card-header h3 {
        /* Düzeltme: Rengi görünür yaptık */
        color: white !important;
        font-size: 1.5rem;
        margin-bottom: 0;

        padding: 10px;
        border-radius: 10px;
        font-weight: bold;
        font-family:"inter";
        font-size:32px;

    }

    .form-group label {
        color: white;
        margin-bottom: 5px;
        font-weight: bold;
    }
    .card-header {
        background: transparent;
        border-bottom: none;
        padding-bottom: 0;
        /* Köşe radius değerleri ana karta uyumlu hale getirildi */
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
    }
    .ml-2 {

        transform: scale(1.3);
       
    }
</style>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header text-center ">
                    <h3 class="mb-0">Create an Account</h3>
                    <div id="recaptcha-container"></div>
                </div>
                <div class="card-body">
                    <form method="post" novalidate id="registerForm">
                        <div class="mb-3 form-group">
                            
                            <input type="text" id="name" name="name" class="form-control" placeholder="Full Name" data-error_message="Lütfen adınızı girin.">
                            
                            <div class="validation-message" id="name-error">
                                <span class="icon">!</span> Lütfen adınızı girin.
                            </div>
                        </div>
                        <div class="mb-3 form-group">
                            <input type="email" id="email" name="email" class="form-control" placeholder="E-mail Address" data-error_message="Geçerli bir e-posta adresi girin.">
                            <div class="validation-message" id="email-error">
                                <span class="icon">!</span> Geçerli bir e-posta adresi girin.
                            </div>
                        </div>
                        <div class="mb-3 form-group">
                            <input type="text" id="username" name="username" class="form-control" placeholder="Username" data-error_message="Lütfen kullanıcı adınızı girin.">
                            <div class="validation-message" id="username-error">
                                <span class="icon">!</span> Lütfen kullanıcı adınızı girin.
                            </div>
                        </div>
                        <div class="mb-3 form-group">
                            <input type="password" id="password" name="password" class="form-control" placeholder="Password" data-error_message="Lütfen bir şifre girin." data-min_length="6">
                            <div class="validation-message" id="password-error">
                                <span class="icon">!</span> Lütfen bir şifre girin.
                            </div>
                        </div>
                        <div class="mb-3 form-group">
                            <input type="password" id="confirm_password" name="confirm" class="form-control" placeholder="Confirm Password" data-error_message="Şifreler eşleşmiyor.">
                            <div class="validation-message" id="confirm_password-error">
                                <span class="icon">!</span> Şifreler eşleşmiyor.
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-block">Register <span><img src="{{ url_for('static', filename='check.svg') }}" alt="Arrow Right" class="ml-2" style="width: 1em; height: 1em;"></span></button>
                        </div>
                        <div class="d-grid">
    <button type="button" class="google-button" id="google-login-btn">Register with Google <img src="{{ url_for('static', filename='googled.svg') }}" alt="Arrow Right" class="ml-2" style="width: 1em; height: 1em;"></button>
</div>

                    </form>
                </div>
                <div class="card-footer text-center">
                    <small class="text-muted">
                        Already have an account? <a href="/login">Sign In</a>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('registerForm');
        const inputs = form.querySelectorAll('input:not([type="submit"]):not([type="hidden"])');

        function showValidationError(inputElement, errorMessage) {
            const errorDiv = document.getElementById(inputElement.id + '-error');
            if (errorDiv) {
                errorDiv.querySelector('.icon').nextSibling.textContent = ' ' + errorMessage;
                errorDiv.classList.add('show');
                inputElement.classList.add('is-invalid');
                inputElement.setAttribute('aria-invalid', 'true');
            }
        }

        function hideValidationError(inputElement) {
            const errorDiv = document.getElementById(inputElement.id + '-error');
            if (errorDiv) {
                errorDiv.classList.remove('show');
                inputElement.classList.remove('is-invalid');
                inputElement.removeAttribute('aria-invalid');
            }
        }

        function validateInput(input) {
            let isValid = true;
            let errorMessage = input.dataset.errorMessage || 'Bu alan zorunludur.';

            if (input.value.trim() === '') {
                isValid = false;
            }

            if (isValid && input.id === 'email') {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(input.value)) {
                    isValid = false;
                    errorMessage = 'Geçerli bir e-posta adresi girin.';
                }
            }

            if (isValid && input.id === 'password') {
                const minLength = parseInt(input.dataset.minLength || 0);
                if (input.value.length < minLength) {
                    isValid = false;
                    errorMessage = `Şifre en az ${minLength} karakter olmalı.`;
                }
            }

            if (isValid && input.id === 'confirm_password') {
                const passwordInput = document.getElementById('password');
                if (input.value !== passwordInput.value) {
                    isValid = false;
                    errorMessage = 'Şifreler eşleşmiyor.';
                }
            }

            if (!isValid) {
                showValidationError(input, errorMessage);
            } else {
                hideValidationError(input);
            }
            return isValid;
        }

        inputs.forEach(input => {
            input.addEventListener('input', () => validateInput(input));
            input.addEventListener('blur', () => validateInput(input));
        });

        form.addEventListener('submit', (event) => {
            let formIsValid = true;
            inputs.forEach(input => {
                if (!validateInput(input)) {
                    formIsValid = false;
                }
            });

            if (!formIsValid) {
                event.preventDefault();
                const firstInvalidInput = form.querySelector('.form-control.is-invalid');
                if (firstInvalidInput) {
                    firstInvalidInput.focus();
                }
            }
        });
    });
</script>

<p id="message" style="text-align:center; margin-top:15px;"></p>

{% endblock%}